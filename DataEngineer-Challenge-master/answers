# Lilly Data Engineer Challenge ‚Äì Answers
### Submitted by Afzal

---

## ‚öΩ Q1: Average Goals per Game (1900‚Äì2000)

**SQL Query:**
```sql
SELECT AVG(home_score + away_score) AS avg_goals
FROM results
WHERE CAST(strftime('%Y', date) AS INTEGER) BETWEEN 1900 AND 2000;
Explanation:

Computes the average number of goals per game.

Filters matches played between 1900 and 2000.

Useful for understanding historical scoring trends.

üèÜ Q2: Shootout Wins by Country (Alphabetical Order)
SQL Query:

sql
Copy code
SELECT winner AS country, COUNT(*) AS shootout_wins
FROM shootouts
GROUP BY winner
ORDER BY winner ASC;
Explanation:

Counts the number of penalty shootout wins per country.

Groups results by winner and sorts alphabetically.

Helps identify historically successful teams in shootouts.

üîë Q3: Create Match ID for Joining Tables
Python Code:

python
Copy code
results['match_id'] = results['date'].astype(str) + '_' + results['home_team'] + '_' + results['away_team']
goals['match_id'] = goals['date'].astype(str) + '_' + goals['home_team'] + '_' + goals['away_team']
shootouts['match_id'] = shootouts['date'].astype(str) + '_' + shootouts['home_team'] + '_' + shootouts['away_team']

results.to_sql('results', conn, if_exists='replace', index=False)
goals.to_sql('goals', conn, if_exists='replace', index=False)
shootouts.to_sql('shootouts', conn, if_exists='replace', index=False)
Explanation:

Creates a unique match_id for reliable joins between goals, results, and shootouts.

Key format: date_homeTeam_awayTeam.

Ensures SQL joins are accurate across datasets.

ü•Ö Q4: Teams That Won Penalty Shootout After 1-1 Draw
SQL Query:

sql
Copy code
SELECT
    T2.winner AS winning_team,
    T1.date,
    T1.home_team,
    T1.away_team,
    T1.tournament
FROM results T1
INNER JOIN shootouts T2
ON T1.match_id = T2.match_id
WHERE T1.home_score = 1 AND T1.away_score = 1;
Explanation:

Identifies matches ending 1-1 that went to a penalty shootout.

Displays the winning team along with match details.

Useful for analyzing performance in tight matches.

‚ö° Q5: Top Goal Scorer by Tournament (% of Total Goals)
SQL Query:

sql
Copy code
WITH goals_with_tournament AS (
    SELECT g.scorer, r.tournament
    FROM goals g
    JOIN results r
    ON g.match_id = r.match_id
),
tournament_goals AS (
    SELECT tournament, COUNT(*) AS total_goals
    FROM goals_with_tournament
    GROUP BY tournament
),
player_goals AS (
    SELECT tournament, scorer, COUNT(*) AS goals
    FROM goals_with_tournament
    GROUP BY tournament, scorer
),
ranked AS (
    SELECT p.tournament, p.scorer, p.goals, t.total_goals,
           ROUND((CAST(p.goals AS FLOAT) / t.total_goals) * 100, 2) AS pct_of_total,
           RANK() OVER (PARTITION BY p.tournament ORDER BY p.goals DESC) AS rank
    FROM player_goals p
    JOIN tournament_goals t
    ON p.tournament = t.tournament
)
SELECT tournament, scorer AS top_scorer, goals, pct_of_total
FROM ranked
WHERE rank = 1
ORDER BY tournament;
Explanation:

Finds the top goal scorer for each tournament.

Calculates the percentage of total tournament goals by that player.

Uses CTEs to organize calculations step-by-step:

goals_with_tournament ‚Äì join goals and tournaments.

tournament_goals ‚Äì total goals per tournament.

player_goals ‚Äì goals per player per tournament.

ranked ‚Äì calculate percentage and rank players.

üßπ Q6: Data Quality Checks and Cleaning
Python Code:

python
Copy code
# Copy goals table
goals_qc = goals.copy()

# Add flag for data quality issues
goals_qc['data_quality_flag'] = 0

# Flag missing scorer
goals_qc.loc[goals_qc['scorer'].isnull() | (goals_qc['scorer'].str.strip() == ''), 'data_quality_flag'] = 1

# Flag invalid minutes
goals_qc.loc[(goals_qc['minute'] < 0) | (goals_qc['minute'] > 120), 'data_quality_flag'] = 1

# Flag missing team
goals_qc.loc[goals_qc['team'].isnull() | (goals_qc['team'].str.strip() == ''), 'data_quality_flag'] = 1

# Clean data
goals_qc['scorer'].fillna('Unknown', inplace=True)
goals_qc.loc[(goals_qc['minute'] < 0) | (goals_qc['minute'] > 120), 'minute'] = None
goals_qc['team'].fillna('Unknown', inplace=True)

# Reset flag
goals_qc['data_quality_flag'] = 0
Explanation:

Flags records with missing or inconsistent data.

Cleans missing scorer, invalid minute, and missing team values.

Ensures the dataset is reliable for further analysis.

pgsql
Copy code
